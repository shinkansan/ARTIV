# CAN 통신으로 차량 제어하기 part2
* __여호영 / 2020.07.06__

## 차량과 CAN 연결하기
차량과 컴퓨터를 CAN으로 연결할 때까지 많은 고생이 있었고 결국엔 성공했다.    
하지만 크게 효과적인 성과는 아니었고 결국 언맨드 솔루션사에서 개조된 장치로 CAN 통신을 하게 되었다.    
그렇다면 언맨드 솔루션에서 만들어준 장치는 어떤 것인가?    
요약하자면 차량의 장치들과 컴퓨터를 CAN 통신으로 연결하기 쉽게 해주는 연결고리를 추가해주었다고 생각하면 된다.    

## VCU란?
Vehicle Control Unit의 약자로 차량의 여러 장치들의 정보를 얻거나 조작하는 역할을 하는 장치라고 보면 된다.    
예를 들면 차량의 바퀴에 달린 엔코더로 차량의 속도를 얻거나, 버튼의 상태를 통해서 깜박이, 안전벨트, 문의 개폐여부 등을 알 수 있다.    
또한 우리의 차량인 아이오닉 같은 경우엔 버튼식 기어이고 엑셀에 엑츄에이터가 있기 때문에 전기로 신호를 입력해 조작할 수 있다.    
실제로 아이오닉의 기본적인 기능으로써 엑셀과 기어를 조작할 수 있다.    
하지만 핸들 및 브레이크에는 기본적인 엑츄에이터가 없기 때문에 따로 엑츄에이터를 추가해 조작하게 된다.(by 언맨드 솔루션)    
그럼 과연 어떤 정보를 받아들이고 보내야 하냐고? 그건 우리팀 Github로 가면 잘 나와 있음!    
어떤 ID가 차량의 어떤 정보에 해당하는지에 대해서 자세히 나와있으며 이것을 CAN DB라고 한다.    
하지만 이것은 언맨드 솔루션에서 받은 기밀 문서이기 때문에 외부 유출 절대 금지!    

## 우리만의 CAN DB를 만들 수 있을까?
해당 목차에 대한 내용은 확실한 것은 아니고 시도해본 적도 없는 방법이다.     
무엇보다도 자율주행차 개발이 목적인 우리 UGRP의 목적에 부합하지 않다고 판단하여 실제로 수행하지 않았다.    
하지만 CAN 통신을 많이 경험한 결과 가능할 것 같은 방법을 여기 적어본다.    
추후에 통신 자체에 관심이 많거나 해킹(같은 분야인지는 모르겠지만)에 관심 있다면 시도해보는 것도 추천한다.    
이 방법은 현재 존재하는 차량에 대한 정보가 부족하며 추가적인 기능(ex. 에어컨 동작 상태, 창문 상태 등)이 필요할 때 시도해볼 수 있다.    
CAN DB를 통해서 CAN 정보를 parsing하면서 생각해본 방법인데 실제로 노가다 작업을 하면서 장치에 해당하는 데이터를 역추적해볼 수 있다.    
각 ID마다 해당하는 차량의 정보가 존재하는데 보통 한 ID에 대해서 8바이트에 대한 정보가 저장된다.    
이 8바이트 중에서 1바이트를 사용해서 int8인 정보를 표현하거나 2바이트를 사용해서 int16인 정보를 표현하는 경우가 있다.    
그리고 각 데이터마다 스케일이 달라서 그 범위또한 예측하기 힘들다.   
그래서 한 ID에 몇 개의 장치에 대한 정보가 들어있는지도 모르며 하나의 장치당 몇바이트가 할당되어 있는지도 모른다.    
게다가 하나의 OBD2 케이블을 통해서 CAN ID가 수십 혹은 수백가지가 들어오기 때문에 하나의 장치를 확인하기 위해서 수백가지를 확인해야 하는 것이다.    
즉 특정한 ID에 대한 정보만 받아오는 기능 혹은 프로그램을 사용하여 특정 행동을 하면서 데이터가 그에 맞게 바뀌는지 확인하는 것이다.    
예를 들면 문의 개폐 여부를 알기 위해서 문을 여닫으면서 0x1-0x100까지 ID의 데이터를 확인하는 것이다.    
(심지어 0x1-0x100처럼 아이디가 연속적이지 않을 수 있다.)    
말 그대로 규칙성을 찾기 힘드며 완전 노가다인 작업이다.    
만약 꼭 필요한 CAN 정보를 얻어야 하거나 해킹(?)에 관심이 많다면 시간을 들여 도전해보는 것도 나쁘지 않을 것이다...    

## 우리는 어떻게 차량의 정보를 얻고 명령을 내릴까?
CAN 통신의 하드웨어는 언맨드 솔루션이 만들어준 장치를 기반으로 사용하며 소프트웨어는 ROS 기반의 프로그램을 사용한다.     
하드웨어는 우리가 실제로 제작하지 않았기 때문에 딱히 제작에 대한 메뉴얼을 제공해줄 수가 없다.    
그렇다면 소프트웨어는 과연 어떻게 구성되어 있을까?    
CAN 통신을 하기 위해서 ROS의 기본 기능을 찾아보다가 Socketcan이라는 패키지를 찾았다.    
자세한 코드 및 기능에 대한 설명은 [여기](http://wiki.ros.org/socketcan_interface)로...  
간단히 말하자면 ROS에서 제공하는 Socketcan이라는 패키지는 CAN 통신을 ROS 방식으로 쉽게 해결할 수 있게 도와주는 툴이다.  
이 툴이 없다면 우리는 CAN의 근본적인 원리를 이해하면서 기능을 전체적으로 구현해야 할 것이다.  
하지만 이 툴을 통해서 우리는 특정한 ros topic을 publish하면 socketcan이 알아서 subscribe한 이후에 CAN 데이터 형식으로 차에 명령을 준다.  
그리고 차량으로부터 CAN 정보를 얻어온 다음에 특정한 topic으로 publish 해준다.  
즉 우리는 CAN의 근본적인 원리 이해를 정확히 하지 않아도 ros topic을 알맞은 형식으로 publish 또는 subscribe하면 된다.  
실제로 socketcan이 publish 해주는 topic은 /received_messages이며 이는 can_msg/Frame 형태로 구성되어 있다.  
그리고 can_msg/Frame 형태로 /sent_messages라는 topic을 우리가 publish 해주면 socketcan 패키지가 알아서 subscribe 한 후에 CAN 정보를 차량에 입력한다.  
결국 CAN 통신의 근본적인 원리에 대한 이해 없이 ros에 대한 지식만 있으면 충분히 진행할 수 있는 것이다!  
자세한건 아래의 구조도를 확인해보자.  
![사진](./media/CAN_construct)
